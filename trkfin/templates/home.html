{% extends "base.html" %}

{% block title %} | Home{% endblock %}

{% block main %}

<style>

.group-title {
  cursor: pointer;
}
.group-name {
  height: 2.5rem;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  border-radius: 3px;
  margin-bottom: 3px;
  padding: 0.5rem;
}
.group-unnamed {
  color: #888;
}
.group-border {
  border-bottom: 1px solid #555;
}
.wallet {
  border-top: 1px solid white;
}
.wallet + .wallet {
  border-color: #aaa;
}
.wallet-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  height: 2rem;
  border-radius: 3px;
  margin: 3px;
  padding: 0.5rem;
}
.wallet-info {
  font-size: 0.9rem;
  display: grid;
  grid-template-columns: 1fr 1fr;
  row-gap: 0.5rem;
  justify-content: end;
  padding-left: 40%;
  margin-bottom: 1.5rem;
  margin-right: 3px;
  padding-right: 0.5rem;
}
.wallet-amount {
  text-align: right;
}
.wallet-amount.income {
  color: green;
}
.wallet-amount.income::before {
  content: "+";
}
.wallet-amount.spending {
  color: red;
}
.wallet-total {
  border-top: 1px solid #aaa;
}
.group-name:hover,
.wallet-title:hover {
  background-color: #eee;
}
.group-name.active,
.wallet-title.active {
  background-color: #ddd;
}
</style>

<div class="section" name='form'>

  <form class="form" action="" method="POST" data-form>
    <div class="btn-group" role="group" aria-label="Select action">
      {% for subfield in form.action %}
      {{ subfield(class_="btn-check") }}
      {{ subfield.label(class_="btn btn-secondary shadow-none") }}
      {% endfor %}
    </div>
    <div class="form-row">
      <div class="form-field input-group" data-form-field="source">
        {{ form.source.label(class_="input-group-text") }}
        {{ form.source(class_="form-control") }}
      </div>
      <div class="form-field input-group" data-form-field="destination">
        {{ form.destination.label(class_="input-group-text") }}
        {{ form.destination(class_="form-control") }}
      </div>    
    </div>
    <div class="form-row">
      <div class="form-field">
        {{ form.amount(class_="form-control") }}
      </div>
      <div class="form-row form-nowrap">
        {{ form.description(class_="form-control") }}
        {{ form.submit(class_="btn btn-secondary") }}
      </div>
    </div>
    {{ form.hidden_tag() }}
  </form>
  
  <div name="form-errors">
    {% for error in form.hidden_tag.errors %}
      hidden: <span style="color: red;">[{{ error }}]</span>
    {% endfor %}
    {% for error in form.source.errors %}
      source: <span style="color: red;">[{{ error }}]</span>
    {% endfor %}
    {% for error in form.destination.errors %}
      dest: <span style="color: red;">[{{ error }}]</span>
    {% endfor %}
    {% for error in form.amount.errors %}
      amount: <span style="color: red;">[{{ error }}]</span>
    {% endfor %}
    {% for error in form.description.errors %}
      descr: <span style="color: red;">[{{ error }}]</span>
    {% endfor %}
  </div>
      
  
  <script>
  
    // show/hide form fields
    const form = document.querySelector('[data-form]');
    const src  = document.querySelector('[data-form-field="source"');
    const dest = document.querySelector('[data-form-field="destination"');
    form.addEventListener('click', function() {
      let select = form.action.value;
      if (select == 'Spending') {
        src.classList.remove('form-hide');
        dest.classList.add('form-hide');
      }
      else if (select == 'Income') {
        src.classList.add('form-hide');
        dest.classList.remove('form-hide');
      }
      else { // 'transfer'
        src.classList.remove('form-hide');
        dest.classList.remove('form-hide');
      }
    });
  
    // select 'spending' as default
    form.action.item(0).click();
  
  </script>
  
</div>

{% if wallets %}
{% for group in wallets['groups'] %}
<div class="section">
  <div class="group">
    <div class="group-title" data-bs-toggle="collapse" data-bs-target="#group-{{ group }}" aria-expanded="false" aria-controls="group-{{ group }}">
      {% if group == "" %}<div class="group-name group-unnamed" data-wallet-title>Ungroupped</div>
      {% else %}<div class="group-name" data-wallet-title>{{ group }}</div>{% endif %}
    </div>
    {% if wallets['groupsize'][group] > 1 %}
    <div class="collapse" id="group-{{ group }}">
      <div class="wallet-info">
        <div>Initial</div>
        <div class="wallet-amount">{{ wallets['sums'][group]['initial_sum'] | num }}</div>
        <div>Income</div>
        <div class="wallet-amount income">{{ wallets['sums'][group]['income_sum'] | num }}</div>
        <div>Spending</div>
        <div class="wallet-amount spending">{{ wallets['sums'][group]['spendings_sum'] | num }}</div>
        <div class="wallet-total">Total</div>
        <div class="wallet-amount wallet-total">{{ wallets['sums'][group]['balance_sum'] | num }}</div>
      </div>
    </div>
    {% endif %}
  </div>
  <div class="group-border"></div>
  {% for w_id in wallets['groups'][group] %}
  <div class="wallet">
    <div class="wallet-title" data-bs-toggle="collapse" data-bs-target="#wallet-body-{{ w_id }}" aria-expanded="false" aria-controls="wallet-body-{{ w_id }}"  data-wallet-title>
      <div>{{ wallets['groups'][group][w_id]['name'] }}</div>
      <div>{{ wallets['groups'][group][w_id]['balance'] | num }}</div>
    </div>
    <div class="collapse" id="wallet-body-{{ w_id }}">
      <div class="wallet-info">
        <div>Initial</div>
        <div class="wallet-amount">{{ wallets['groups'][group][w_id]['initial'] | num }}</div>
        <div>Income</div>
        <div class="wallet-amount income">{{ wallets['groups'][group][w_id]['income'] | num }}</div>
        <div>Spending</div>
        <div class="wallet-amount spending">{{ wallets['groups'][group][w_id]['spendings'] | num}}</div>
        <div>Transfers</div>
        <div class="wallet-amount">{{ wallets['groups'][group][w_id]['transfers'] | num }}</div>
        <div class="wallet-total">Balance</div>
        <div class="wallet-amount wallet-total">{{ wallets['groups'][group][w_id]['balance'] | num }}</div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endfor %}
{% endif %}

<script>
document.querySelectorAll('[data-wallet-title]').forEach(x => {
  x.addEventListener('click', () => {
    x.classList.toggle('active');
  });
});
</script>

{% endblock %}
