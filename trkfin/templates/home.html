{% extends "base.html" %}

{% block title %} | Home{% endblock %}

{% block main %}

<style>
  
.group {
  border-bottom: 1px solid #555;
  color: #444;
}
.group-unnamed:not(.active) {
  color: #ccc;
  border-color: #eee;
  transition: all 0.5s ease;
}

.group-title,
.wallet-title {
  cursor: pointer;
  display: flex;
  align-items: center;
  border-radius: 3px;
  padding: 0.5rem;
}
.group-title {  
  height: 2.5rem;
  font-size: 1.1rem;
  font-weight: bold;
  margin-bottom: 3px;
  transition: all 0.5s ease;
}
.wallet-title {
  height: 2rem;
  margin: 3px;
  justify-content: space-between;
}
.group-title:hover,
.wallet-title:hover {
  background-color: #eee;
}
.group.active .group-title,
.wallet-title.active {
  background-color: #ddd;
}

.wallet {
  border-top: 1px solid white;
}
.wallet + .wallet {
  border-color: #aaa;
}

.wallet-info {
  font-size: 0.9rem;
  display: grid;
  grid-template-columns: max-content max-content;
  justify-content: end;
  row-gap: 0.5rem;
  margin-bottom: 1.5rem;
  margin-right: 3px;
  padding-right: 0.5rem;
}

.wallet-amount {
  text-align: right;
  padding-left: 3rem;
}
.wallet-amount.income {color: green;}
.wallet-amount.spending {color: red;}
.wallet-total {
  border-top: 1px solid #aaa;
  padding-top: 0.3rem;
}

</style>

<div class="section" name='form'>

  <form class="form" action="" method="POST" data-form>
    <div class="btn-group" role="group" aria-label="Select action">
      {% for subfield in form.action %}
      {{ subfield(class_="btn-check") }}
      {{ subfield.label(class_="btn btn-secondary shadow-none") }}
      {% endfor %}
    </div>
    <div class="form-row">
      <div class="form-field input-group" data-form-field="source">
        {{ form.source.label(class_="input-group-text") }}
        {{ form.source(class_="form-control") }}
      </div>
      <div class="form-field input-group" data-form-field="destination">
        {{ form.destination.label(class_="input-group-text") }}
        {{ form.destination(class_="form-control") }}
      </div>    
    </div>
    <div class="form-row">
      <div class="form-field">
        {{ form.amount(class_="form-control") }}
      </div>
      <div class="form-row form-nowrap">
        {{ form.description(class_="form-control") }}
        {{ form.submit(class_="btn btn-secondary") }}
      </div>
    </div>
    {{ form.hidden_tag() }}
  </form>
  
  <div name="form-errors">
    {% for error in form.hidden_tag.errors %}
      hidden: <span style="color: red;">[{{ error }}]</span>
    {% endfor %}
    {% for error in form.source.errors %}
      source: <span style="color: red;">[{{ error }}]</span>
    {% endfor %}
    {% for error in form.destination.errors %}
      dest: <span style="color: red;">[{{ error }}]</span>
    {% endfor %}
    {% for error in form.amount.errors %}
      amount: <span style="color: red;">[{{ error }}]</span>
    {% endfor %}
    {% for error in form.description.errors %}
      descr: <span style="color: red;">[{{ error }}]</span>
    {% endfor %}
  </div>
      
  
  <script>
  
    // show/hide form fields
    const form = document.querySelector('[data-form]');
    const src  = document.querySelector('[data-form-field="source"');
    const dest = document.querySelector('[data-form-field="destination"');
    form.addEventListener('click', function() {
      let select = form.action.value;
      if (select == 'Spending') {
        src.classList.remove('form-hide');
        dest.classList.add('form-hide');
      }
      else if (select == 'Income') {
        src.classList.add('form-hide');
        dest.classList.remove('form-hide');
      }
      else { // 'transfer'
        src.classList.remove('form-hide');
        dest.classList.remove('form-hide');
      }
    });
  
    // select 'spending' as default
    form.action.item(0).click();
  
  </script>
  
</div>

{% if wallets %}
{% for group in wallets['groups'] %}
<div class="section">
  
  <div {% if group == "" %}class="group group-unnamed"{% else %}class="group"{% endif %} data-bs-toggle="collapse" data-bs-target="#group-{{ group }}" aria-expanded="false" aria-controls="group-{{ group }}" data-wallet-title>
    <div class="group-title">{{ group or "Ungroupped" }}</div>
    {% if wallets['groupsize'][group] > 1 %}
    <div class="collapse" id="group-{{ group }}">
      <div class="wallet-info">
        <div>Initial</div>
        <div class="wallet-amount">{{ wallets['sums'][group]['initial_sum'] | num }}</div>
        <div>Income</div>
        <div class="wallet-amount income">{{ wallets['sums'][group]['income_sum'] | num }}</div>
        <div>Spending</div>
        <div class="wallet-amount spending">{{ wallets['sums'][group]['spendings_sum'] | num }}</div>
        <div class="wallet-total">Total</div>
        <div class="wallet-amount wallet-total">{{ wallets['sums'][group]['balance_sum'] | num }}</div>
      </div>
    </div>
    {% endif %}
  </div>
    
  {% for w_id in wallets['groups'][group] %}
  <div class="wallet">
    <div class="wallet-title" data-bs-toggle="collapse" data-bs-target="#wallet-body-{{ w_id }}" aria-expanded="false" aria-controls="wallet-body-{{ w_id }}"  data-wallet-title>
      <div>{{ wallets['groups'][group][w_id]['name'] }}</div>
      <div>{{ wallets['groups'][group][w_id]['balance'] | num }}</div>
    </div>
    <div class="collapse" id="wallet-body-{{ w_id }}">
      <div class="wallet-info">
        <div>Initial</div>
        <div class="wallet-amount">{{ wallets['groups'][group][w_id]['initial'] | num }}</div>
        <div>Income</div>
        <div class="wallet-amount income">{{ wallets['groups'][group][w_id]['income'] | num }}</div>
        <div>Spending</div>
        <div class="wallet-amount spending">{{ wallets['groups'][group][w_id]['spendings'] | num}}</div>
        <div>Transfers</div>
        <div class="wallet-amount">{{ wallets['groups'][group][w_id]['transfers'] | num }}</div>
        <div class="wallet-total">Balance</div>
        <div class="wallet-amount wallet-total">{{ wallets['groups'][group][w_id]['balance'] | num }}</div>
      </div>
    </div>
  </div>
  {% endfor %}

</div>
{% endfor %}
{% endif %}

<script>
document.querySelectorAll('[data-wallet-title]').forEach(x => {
  x.addEventListener('click', () => {
    x.classList.toggle('active');
  });
});
</script>

{% endblock %}
